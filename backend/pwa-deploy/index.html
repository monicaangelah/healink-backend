<!DOCTYPE html>
<html>
<head>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#007bff" />
    <title>IoT Sensor Dashboard</title>
</head>
<body>
  <h1>Realtime Sensor Data</h1>
  <div id="realtime"></div>
  <h2>History</h2>
  <ul id="history"></ul>

  <script>
    const realtimeDiv = document.getElementById('realtime');
    const historyList = document.getElementById('history');

    const ws = new WebSocket('wss://healink-backend-production.up.railway.app');

    // Threshold batas aman
    const BPM_THRESHOLD = 50;
    const TEMP_LOW_THRESHOLD = 35;
    const TEMP_HIGH_THRESHOLD = 40;
    const SPO2_THRESHOLD = 90;

    // Variabel tracking kondisi triase darurat
    let triaseStartTimestamp = null;
    let triaseNotified = false;

    // Fungsi cek dan request permission notifikasi
    function requestNotificationPermission() {
      if (Notification.permission === "default") {
        Notification.requestPermission().then(permission => {
          console.log("Notification permission:", permission);
        });
      }
    }
    requestNotificationPermission();

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === 'history') {
        historyList.innerHTML = '';
        msg.data.forEach(item => {
          const li = document.createElement('li');
          li.textContent = `Temp: ${item.temperature} °C, BPM: ${item.bpm}, SpO2: ${item.spo2}, Time: ${new Date(item.created_at).toLocaleString()}`;
          historyList.appendChild(li);
        });
      } else if (msg.type === 'realtime') {
        // Pastikan data tipe number
        const bpm = Number(msg.bpm);
        const temp = Number(msg.temperature);
        const spo2 = Number(msg.spo2);

        realtimeDiv.textContent = `Temp: ${temp} °C, BPM: ${bpm}, SpO2: ${spo2}`;

        const li = document.createElement('li');
        li.textContent = `Temp: ${temp} °C, BPM: ${bpm}, SpO2: ${spo2}, Time: ${new Date().toLocaleString()}`;
        historyList.insertBefore(li, historyList.firstChild);

        if (historyList.children.length > 50) {
          historyList.removeChild(historyList.lastChild);
        }

        const bpmValid = bpm > 0;
        const tempValid = temp > 0;
        const spo2Valid = spo2 > 0;

        const isDangerous = bpmValid && tempValid && spo2Valid && (
          (bpm < BPM_THRESHOLD) ||
          (temp < TEMP_LOW_THRESHOLD || temp > TEMP_HIGH_THRESHOLD) ||
          (spo2 < SPO2_THRESHOLD)
        );

        console.log(`BPM: ${bpm}, Temp: ${temp}, SpO2: ${spo2}, isDangerous: ${isDangerous}`);

        if (isDangerous) {
          if (!triaseStartTimestamp) {
            triaseStartTimestamp = Date.now();
            triaseNotified = false;
          } else {
            const elapsed = Date.now() - triaseStartTimestamp;
            console.log(`Elapsed dangerous condition: ${elapsed} ms`);
            if (elapsed >= 60000 && !triaseNotified) {
              if (Notification.permission === "granted") {
                new Notification("Triase Darurat!", {
                  body: `Detak jantung, suhu, dan SpO2 berada di luar batas aman selama 1 menit! Segera cek pasien.`,
                  icon: "https://cdn-icons-png.flaticon.com/512/1828/1828665.png"
                });
                triaseNotified = true;
              } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                  if (permission === "granted") {
                    new Notification("Triase Darurat!", {
                      body: `Detak jantung, suhu, dan SpO2 berada di luar batas aman selama 1 menit! Segera cek pasien.`,
                      icon: "https://cdn-icons-png.flaticon.com/512/1828/1828665.png"
                    });
                    triaseNotified = true;
                  }
                });
              } else {
                console.log("Notification permission denied");
              }
            }
          }
        } else {
          triaseStartTimestamp = null;
          triaseNotified = false;
        }
      }
    };

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log('Service Worker registered successfully'))
        .catch(err => console.error('Service Worker registration failed:', err));
    }
  </script>
</body>
</html>
