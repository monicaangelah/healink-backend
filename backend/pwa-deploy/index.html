<!DOCTYPE html>
<html>
<head>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#007bff" />
    <title>IoT Sensor Dashboard</title>
</head>
<body>
  <h1>Realtime Sensor Data</h1>
  <div id="realtime"></div>
  <h2>History</h2>
  <ul id="history"></ul>

  <script>
    const realtimeDiv = document.getElementById('realtime');
    const historyList = document.getElementById('history');

    const ws = new WebSocket('wss://healink-backend-production.up.railway.app');

    // Threshold batas aman
    const BPM_THRESHOLD = 50;
    const TEMP_LOW_THRESHOLD = 35;
    const TEMP_HIGH_THRESHOLD = 40;
    const SPO2_THRESHOLD = 90;

    // Variabel tracking kondisi triase darurat
    let triaseStartTimestamp = null;
    let triaseNotified = false;

    // Fungsi cek dan request permission notifikasi
    function requestNotificationPermission() {
      if (Notification.permission === "default") {
        Notification.requestPermission().then(permission => {
          console.log("Notification permission:", permission);
        });
      }
    }
    requestNotificationPermission();

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === 'history') {
        // Clear dan render ulang data history
        historyList.innerHTML = '';
        msg.data.forEach(item => {
          const li = document.createElement('li');
          li.textContent = `Temp: ${item.temperature} °C, BPM: ${item.bpm}, SpO2: ${item.spo2}, Time: ${new Date(item.created_at).toLocaleString()}`;
          historyList.appendChild(li);
        });
      } else if (msg.type === 'realtime') {
        // Update realtime div
        realtimeDiv.textContent = `Temp: ${msg.temperature} °C, BPM: ${msg.bpm}, SpO2: ${msg.spo2}`;

        // Tambah data realtime ke history list paling atas
        const li = document.createElement('li');
        li.textContent = `Temp: ${msg.temperature} °C, BPM: ${msg.bpm}, SpO2: ${msg.spo2}, Time: ${new Date().toLocaleString()}`;
        historyList.insertBefore(li, historyList.firstChild);

        // Batasi history maksimal 50 item
        if (historyList.children.length > 50) {
          historyList.removeChild(historyList.lastChild);
        }

        // --- Logic triase darurat ---
        // Cek apakah kondisi berbahaya:
        // BPM < 50, suhu < 35 atau > 40, SPO2 < 90, dan semua > 0 (valid)
        const bpmValid = msg.bpm > 0;
        const tempValid = msg.temperature > 0;
        const spo2Valid = msg.spo2 > 0;

        const isDangerous = bpmValid && tempValid && spo2Valid && (
          (msg.bpm < BPM_THRESHOLD) ||
          (msg.temperature < TEMP_LOW_THRESHOLD || msg.temperature > TEMP_HIGH_THRESHOLD) ||
          (msg.spo2 < SPO2_THRESHOLD)
        );

        if (isDangerous) {
          // Mulai atau lanjut hitung durasi triase
          if (!triaseStartTimestamp) {
            triaseStartTimestamp = Date.now();
            triaseNotified = false;
          } else {
            const elapsed = Date.now() - triaseStartTimestamp;
            if (elapsed >= 60000 && !triaseNotified) { // 1 menit
              if (Notification.permission === "granted") {
                new Notification("Triase Darurat!", {
                  body: `Detak jantung, suhu, dan SpO2 berada di luar batas aman selama 1 menit! Segera cek pasien.`,
                  icon: "https://cdn-icons-png.flaticon.com/512/1828/1828665.png"
                });
              } else {
                // Minta izin dulu
                Notification.requestPermission().then(permission => {
                  console.log("Permission result:", permission);
                  if (permission === "granted") {
                    new Notification("Tes Notifikasi", { body: "Notifikasi aktif setelah izin!" });
                  }
                });
              }
              triaseNotified = true;
            }
          }
        } else {
          // Reset timer jika kondisi sudah normal
          triaseStartTimestamp = null;
          triaseNotified = false;
        }
      }
    };

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log('Service Worker registered successfully'))
        .catch(err => console.error('Service Worker registration failed:', err));
    }
  </script>
</body>
</html>
