<!DOCTYPE html>
<html lang="id">
<head>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#007bff" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HeaLink Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #FFFCF8;
      color: #222;
    }
    * {
      box-sizing: border-box;
    }
    #app {
      max-width: 1440px;
      margin: 20px auto;
      padding: 20px 30px;
      background: #FFFCF8;
      border-radius: 40px;
      box-shadow: 0 4px 90px rgba(0,0,0,0.06);
      display: flex;
      gap: 20px;
      min-height: 80vh;
    }
    #leftPanel {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    #headerOverview {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 3px 10px rgb(0 0 0 / 0.05);
      position: relative;
    }
    #headerOverview h2 {
      margin: 0 0 8px 0;
      font-weight: 700;
      font-size: 1.8rem;
    }
    #clock {
      position: absolute;
      top: 20px;
      right: 20px;
      font-weight: 700;
      font-size: 1.2rem;
      color: #444;
      user-select: none;
    }
    #overviewStats {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    .statusBox {
      flex: 1;
      border-radius: 12px;
      padding: 12px 20px;
      font-weight: 700;
      font-size: 1.2rem;
      color: #000;
      text-align: center;
    }
    .statusGreen { background: #b8f1cd; }
    .statusYellow { background: #f8f0ad; }
    .statusRed { background: #f9c3b0; }

    #unitGrid {
      display: grid;
      grid-template-columns: 180px;
      gap: 20px;
    }

    .unitCard {
      background: white;
      border-radius: 16px;
      padding: 24px 28px;
      box-shadow: 0 3px 10px rgb(0 0 0 / 0.05);
      cursor: pointer;
      position: relative;
      transition: transform 0.2s ease;
      user-select: none;
    }
    .unitCard:hover {
      transform: translateY(-5px);
    }
    .unitCard.disabled {
      background: #fff;
      color: #3b3838;
      cursor: default;
      box-shadow: none;
    }
    .unitStatus {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 10px;
      color: #222;
    }
    .unitStatus.Green { background: #b8f1cd; }
    .unitStatus.Yellow { background: #f8f0ad; }
    .unitStatus.Red { background: #f9c3b0; }
    .unitCode {
      font-weight: 900;
      font-size: 1.6rem;
      margin-bottom: 12px;
    }
    .unitInfo {
      font-size: 1.1rem;
      line-height: 1.4;
    }
    .unitInfo span {
      font-weight: 600;
    }

    #rightPanel {
      flex: 1.3;
      background: #2e2e2e;
      border-radius: 40px;
      padding: 24px 20px 30px;
      color: white;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    #detailHeader {
      font-weight: 900;
      font-size: 2.2rem;
      user-select: none;
    }

    #detailHistory {
      background: #4a4a4a;
      border-radius: 16px;
      padding: 8px 10px;
      max-height: 120px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.85rem;
      white-space: pre-line;
      line-height: 1.4;
    }

    .chartCard {
      background: #fff;
      border-radius: 16px;
      padding: 10px 12px;
      color: #000;
    }

    .chartCard h3 {
      margin: 0 0 8px 0;
      font-weight: 700;
      text-align: center;
      font-size: 1.1rem;
    }

    canvas {
      max-width: 100%;
      height: 80px !important;
    }

    /* Popup dan overlay */
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 9998;
    }
    #emergencyPopup {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border-radius: 24px;
      padding: 40px 30px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      z-index: 9999;
      max-width: 400px;
      min-width: 300px;
      text-align: center;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #emergencyPopup button#closePopupBtn {
      position: absolute;
      top: 15px; right: 15px;
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      font-weight: bold;
    }
    #emergencyPopup h1 {
      margin-bottom: 12px;
      font-weight: 900;
    }
    #emergencyPopup .warning-icon {
      font-size: 64px;
      color: #d32f2f;
      margin-bottom: 12px;
    }
    #emergencyPopup #emergencyUnitCode {
      font-weight: 900;
      font-size: 36px;
      margin-bottom: 12px;
    }
    #emergencyPopup .message {
      font-size: 18px;
      margin-bottom: 20px;
    }
    #emergencyPopup button#viewEmergencyBtn {
      background: #388e3c;
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-weight: 700;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
    }

    /* Responsif untuk layar kecil (tablet & HP) */
    @media screen and (max-width: 768px) {
      #app {
        flex-direction: column;
        max-width: 100%;
        margin: 10px;
        padding: 10px 15px;
        min-height: auto;
        border-radius: 20px;
        box-shadow: none;
      }

      #leftPanel, #rightPanel {
        flex: unset;
        width: 100%;
        padding: 10px 0;
        border-radius: 20px;
      }

      #rightPanel {
        padding: 16px 12px 20px;
        margin-top: 20px;
      }

      #headerOverview {
        padding: 15px 20px;
        border-radius: 20px;
        box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      }

      #headerOverview h2 {
        font-size: 1.4rem;
      }

      #clock {
        font-size: 1rem;
        top: 12px;
        right: 12px;
      }

      #overviewStats {
        flex-direction: column;
        gap: 10px;
      }

      .statusBox {
        font-size: 1rem;
        padding: 10px 15px;
      }

      #unitGrid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 15px;
      }

      .unitCard {
        padding: 18px 22px;
        border-radius: 20px;
      }

      .unitCode {
        font-size: 1.3rem;
      }

      .unitInfo {
        font-size: 1rem;
      }

      #rightPanel {
        border-radius: 20px;
        color: white;
      }

      #detailHeader {
        font-size: 1.6rem;
      }

      #detailHistory {
        max-height: 100px;
        font-size: 0.8rem;
        padding: 6px 8px;
      }

      .chartCard {
        padding: 6px 8px;
      }

      .chartCard h3 {
        font-size: 1rem;
      }

      canvas {
        height: 50px !important;
      }

      /* Popup Darurat agar sesuai layar kecil */
      #emergencyPopup {
        max-width: 90vw;
        min-width: auto;
        padding: 25px 20px;
        border-radius: 20px;
      }

      #emergencyPopup h1 {
        font-size: 1.5rem;
      }

      #emergencyPopup .warning-icon {
        font-size: 48px;
      }

      #emergencyPopup #emergencyUnitCode {
        font-size: 28px;
      }

      #emergencyPopup .message {
        font-size: 16px;
      }

      #emergencyPopup button#viewEmergencyBtn {
        font-size: 14px;
        padding: 10px 18px;
      }
    }
  </style>
</head>
<body>

<div id="app">
  <div id="leftPanel">
    <div id="headerOverview">
      <h2>Dashboard HeaLink</h2>
      <div id="clock">--:--:--</div>
      <ul>
        <li>Total Jumlah Pasien: <span id="totalPatients">1</span></li>
        <li>Status Triase</li>
      </ul>
      <div id="overviewStats">
        <div class="statusBox statusGreen">Hijau<br><span id="countGreen">0 orang</span></div>
        <div class="statusBox statusYellow">Kuning<br><span id="countYellow">0 orang</span></div>
        <div class="statusBox statusRed">Merah<br><span id="countRed">0 orang</span></div>
      </div>
    </div>

    <div id="unitGrid">
      <!-- Hanya satu kotak -->
      <div class="unitCard disabled" id="unit1A">
        <div class="unitCode">1A</div>
        <div class="unitStatus" id="unit1AStatus">Tidak Ada</div>
        <div class="unitInfo"><span>Suhu</span> - °C</div>
        <div class="unitInfo"><span>SpO2</span> -</div>
        <div class="unitInfo"><span>BPM</span> -</div>
      </div>
    </div>
  </div>

  <div id="rightPanel">
    <div id="detailHeader">Pilih unit</div>
    <div id="detailHistory">Tidak ada data</div>

    <div class="chartCard">
      <h3>Suhu Tubuh</h3>
      <canvas id="chartTemp"></canvas>
    </div>
    <div class="chartCard">
      <h3>Saturasi Oksigen</h3>
      <canvas id="chartSpo2"></canvas>
    </div>
    <div class="chartCard">
      <h3>Detak Jantung/menit</h3>
      <canvas id="chartBpm"></canvas>
    </div>
  </div>
</div>

<!-- Overlay dan Popup Darurat -->
<div id="overlay"></div>
<div id="emergencyPopup">
  <button id="closePopupBtn">×</button>
  <h1>PASIEN DARURAT</h1>
  <div class="warning-icon">&#9888;</div>
  <div id="emergencyUnitCode">A1</div>
  <div class="message">Segera Ambil Tindakan!</div>
  <button id="viewEmergencyBtn">LIHAT</button>
</div>

<script>
  // Update jam realtime
  function updateClock() {
    const clockEl = document.getElementById('clock');
    const now = new Date();
    const h = now.getHours().toString().padStart(2,'0');
    const m = now.getMinutes().toString().padStart(2,'0');
    const s = now.getSeconds().toString().padStart(2,'0');
    clockEl.textContent = `${h}:${m}:${s}`;
  }
  setInterval(updateClock, 1000);
  updateClock();

  const unit1A = document.getElementById('unit1A');
  const unit1AStatusLabel = document.getElementById('unit1AStatus');
  const detailHeader = document.getElementById('detailHeader');
  const detailHistory = document.getElementById('detailHistory');

  // Chart setup
  const ctxTemp = document.getElementById('chartTemp').getContext('2d');
  const ctxSpo2 = document.getElementById('chartSpo2').getContext('2d');
  const ctxBpm = document.getElementById('chartBpm').getContext('2d');

  const chartTemp = new Chart(ctxTemp, {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'Suhu', data: [], borderColor: '#f39c12', fill: true, backgroundColor: 'rgba(243,156,18,0.2)' }] },
    options: {
      scales: { y: { min: 33, max: 42 }, x: { display: false } },
      plugins: { legend: { display: false } },
      responsive: true,
      animation: false,
      elements: { point: { radius: 0 } }
    }
  });
  const chartSpo2 = new Chart(ctxSpo2, {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'SpO2', data: [], borderColor: '#e74c3c', fill: true, backgroundColor: 'rgba(231,76,60,0.2)' }] },
    options: {
      scales: { y: { min: 80, max: 100 }, x: { display: false } },
      plugins: { legend: { display: false } },
      responsive: true,
      animation: false,
      elements: { point: { radius: 0 } }
    }
  });
  const chartBpm = new Chart(ctxBpm, {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'BPM', data: [], borderColor: '#3498db', fill: true, backgroundColor: 'rgba(52,152,219,0.2)' }] },
    options: {
      scales: { y: { min: 30, max: 130 }, x: { display: false } },
      plugins: { legend: { display: false } },
      responsive: true,
      animation: false,
      elements: { point: { radius: 0 } }
    }
  });

  // Data histori untuk 1A
  let historyData = [];

  // Timer notifikasi darurat
  let emergencyStartTime = null;
  let emergencyTimeout = null;
  let currentEmergencyUnit = null;

  // Fungsi tampilkan popup darurat
  function showEmergencyPopup(unitCode) {
    currentEmergencyUnit = unitCode;
    document.getElementById('emergencyUnitCode').textContent = unitCode;
    document.getElementById('overlay').style.display = 'block';
    document.getElementById('emergencyPopup').style.display = 'block';
  }

  // Fungsi sembunyikan popup darurat
  function hideEmergencyPopup() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('emergencyPopup').style.display = 'none';
    emergencyStartTime = null;
    if (emergencyTimeout) {
      clearTimeout(emergencyTimeout);
      emergencyTimeout = null;
    }
    currentEmergencyUnit = null;
  }

  // Logika cek status merah selama 1 menit (60000 ms)
  function checkEmergencyStatus(status, unitCode) {
    if (status === 'Red') {
      if (!emergencyStartTime) {
        emergencyStartTime = Date.now();
        emergencyTimeout = setTimeout(() => {
          showEmergencyPopup(unitCode);
        }, 1000);
      }
    } else {
      emergencyStartTime = null;
      if (emergencyTimeout) {
        clearTimeout(emergencyTimeout);
        emergencyTimeout = null;
      }
      hideEmergencyPopup();
    }
  }

  // Fungsi update warna status kotak 1A berdasar sensor
  function updateStatusColor(suhu, bpm, spo2) {
    let status = 'Green';

    if ((bpm < 50) || (spo2 < 85) || (suhu < 35) || (suhu > 40)) {
      status = 'Red';
    } else if ((bpm >= 50 && bpm <= 55) || (suhu === 34 || suhu === 38 || suhu === 39) || (spo2 > 85 && spo2 < 88)) {
      status = 'Yellow';
    } else {
      status = 'Green';
    }

    unit1A.classList.remove('Green', 'Yellow', 'Red');
    unit1A.classList.add(status);
    unit1A.style.backgroundColor = status === 'Green' ? '#b8f1cd' : status === 'Yellow' ? '#f8f0ad' : '#f9c3b0';

    unit1AStatusLabel.textContent = status;
    unit1AStatusLabel.className = 'unitStatus ' + status;

    // Update jumlah pasien di dashboard
    document.getElementById('totalPatients').textContent = 1;
    document.getElementById('countGreen').textContent = status === 'Green' ? '1 orang' : '0 orang';
    document.getElementById('countYellow').textContent = status === 'Yellow' ? '1 orang' : '0 orang';
    document.getElementById('countRed').textContent = status === 'Red' ? '1 orang' : '0 orang';

    // Cek kondisi darurat
    checkEmergencyStatus(status, '1A');
  }

  // Update histori text
  function updateHistoryDisplay() {
    if(historyData.length === 0) {
      detailHistory.textContent = "Tidak ada data";
      return;
    }
    const lines = historyData.map(h => {
      return `Suhu : ${h.temperature.toFixed(1)} °C, BPM : ${h.bpm}, SpO2 : ${h.spo2}, Time : ${new Date(h.timestamp).toLocaleString()}`;
    });
    detailHistory.textContent = lines.join('\n');
  }

  // Update grafik dengan data histori
  function updateChartData() {
    if(historyData.length === 0) return;

    const labels = historyData.map(h => new Date(h.timestamp).toLocaleTimeString());

    chartTemp.data.labels = labels;
    chartSpo2.data.labels = labels;
    chartBpm.data.labels = labels;

    chartTemp.data.datasets[0].data = historyData.map(h => h.temperature);
    chartSpo2.data.datasets[0].data = historyData.map(h => h.spo2);
    chartBpm.data.datasets[0].data = historyData.map(h => h.bpm);

    chartTemp.update();
    chartSpo2.update();
    chartBpm.update();
  }

  // Bersihkan data grafik
  function clearChartData() {
    chartTemp.data.labels = [];
    chartSpo2.data.labels = [];
    chartBpm.data.labels = [];

    chartTemp.data.datasets[0].data = [];
    chartSpo2.data.datasets[0].data = [];
    chartBpm.data.datasets[0].data = [];

    chartTemp.update();
    chartSpo2.update();
    chartBpm.update();
  }

  // Saat klik kotak 1A, aktifkan dan update detail
  unit1A.addEventListener('click', () => {
    detailHeader.textContent = '1A';
  });

  // Event tombol popup
  document.getElementById('viewEmergencyBtn').onclick = () => {
    detailHeader.textContent = currentEmergencyUnit;
    hideEmergencyPopup();
  };
  document.getElementById('closePopupBtn').onclick = () => {
    hideEmergencyPopup();
  };

  // Simulasi koneksi WebSocket data realtime, ganti sesuai backend kamu
  // Contoh simulasi update data tiap 5 detik
  setInterval(() => {
    const now = new Date();
    // Simulasi data sensor random normal
    const newData = {
      temperature: 35 + Math.random() * 6,  // 35-41 derajat
      bpm: 45 + Math.floor(Math.random() * 90), // 45-135 bpm
      spo2: 80 + Math.floor(Math.random() * 20), // 80-100%
      timestamp: now.toISOString()
    };

    // Push ke histori, max 10 data
    historyData.unshift(newData);
    if(historyData.length > 10) historyData.pop();

    // Update tampilan unit 1A
    unit1A.querySelector('.unitInfo:nth-child(3)').textContent = `Suhu ${newData.temperature.toFixed(1)} °C`;
    unit1A.querySelector('.unitInfo:nth-child(4)').textContent = `SpO2 ${newData.spo2.toFixed(1)}`;
    unit1A.querySelector('.unitInfo:nth-child(5)').textContent = `BPM ${newData.bpm}`;

    // Update warna, history, grafik, dan cek notifikasi
    updateStatusColor(newData.temperature, newData.bpm, newData.spo2);
    updateHistoryDisplay();
    updateChartData();

    // Set detail header otomatis ke 1A kalau belum pilih
    if(detailHeader.textContent === 'Pilih unit') {
      detailHeader.textContent = '1A';
    }
  }, 5000);

</script>

</body>
</html>
